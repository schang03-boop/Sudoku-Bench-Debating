const loadFPuzzle=(()=>{const fpuzzlesTinyIdLength=20,getRegionShape=(size=9)=>{let height=Math.sqrt(size);if(Number.isInteger(height))return[height,height];for(height=Math.floor(height);!Number.isInteger(size/height)&&1<height;)height--;return 0<height?[height,size/height]:[1,1]},highlightColours="#a8a8a8a8,#000,#ffa0a0,#ffdf61,#feffaf,#b0ffb0,#61d060,#d0d0ff,#8180f0,#ff08ff,#ffd0d0".split(","),littlekillerDirs={UR:[-1,1],UL:[-1,-1],DR:[1,1],DL:[1,-1]},layerOrder="size,title,author,ruleset,clone,grid,disjointgroups,thermometer,killercage,arrow,difference,ratio,betweenline,lockout,quadruple,rectangle,circle,text,palindrome,line,minimum,maximum".split(","),base64Codec=(f=String.fromCharCode,keyStrBase64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\\",baseReverseDic={},{decompress:function(input){if(null==input)return"";if(""==input)return null;var i,w,bits,resb,maxpower,power,c,length=input.length,resetValue=32,getNextValue=function(index){var alphabet=keyStrBase64,index=input.charAt(index);if(!baseReverseDic[alphabet]){baseReverseDic[alphabet]={};for(var i=0;i<alphabet.length;i++)baseReverseDic[alphabet][alphabet.charAt(i)]=i}return baseReverseDic[alphabet][index]},dictionary=[],enlargeIn=4,dictSize=4,numBits=3,entry="",result=[],data={val:getNextValue(0),position:resetValue,index:1};for(i=0;i<3;i++)dictionary[i]=i;for(bits=0,maxpower=Math.pow(2,2),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;switch(bits){case 0:for(bits=0,maxpower=Math.pow(2,8),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;c=f(bits);break;case 1:for(bits=0,maxpower=Math.pow(2,16),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;c=f(bits);break;case 2:return""}for(w=dictionary[3]=c,result.push(c);;){if(length<data.index)return"";for(bits=0,maxpower=Math.pow(2,numBits),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;switch(c=bits){case 0:for(bits=0,maxpower=Math.pow(2,8),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;dictionary[dictSize++]=f(bits),c=dictSize-1,enlargeIn--;break;case 1:for(bits=0,maxpower=Math.pow(2,16),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(0<resb?1:0)*power,power<<=1;dictionary[dictSize++]=f(bits),c=dictSize-1,enlargeIn--;break;case 2:return result.join("")}if(0==enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),dictionary[c])entry=dictionary[c];else{if(c!==dictSize)return null;entry=w+w.charAt(0)}result.push(entry),dictionary[dictSize++]=w+entry.charAt(0),w=entry,0==--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++)}},compress:function(input){if(null===input)return"";var res=function(uncompressed,bitsPerChar,getCharFromInt){if(null==uncompressed)return"";var i,value,ii,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_data=[],context_data_val=0,context_data_position=0;for(ii=0;ii<uncompressed.length;ii++)if(context_c=uncompressed.charAt(ii),Object.prototype.hasOwnProperty.call(context_dictionary,context_c)||(context_dictionary[context_c]=context_dictSize++,context_dictionaryToCreate[context_c]=!0),context_wc=context_w+context_c,Object.prototype.hasOwnProperty.call(context_dictionary,context_wc))context_w=context_wc;else{if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++)context_data_val<<=1,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++;for(value=context_w.charCodeAt(0),i=0;i<8;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}else{for(value=1,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value=0;for(value=context_w.charCodeAt(0),i=0;i<16;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),delete context_dictionaryToCreate[context_w]}else for(value=context_dictionary[context_w],i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),context_dictionary[context_wc]=context_dictSize++,context_w=String(context_c)}if(""!==context_w){if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++)context_data_val<<=1,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++;for(value=context_w.charCodeAt(0),i=0;i<8;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}else{for(value=1,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value=0;for(value=context_w.charCodeAt(0),i=0;i<16;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),delete context_dictionaryToCreate[context_w]}else for(value=context_dictionary[context_w],i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++)}for(value=2,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;for(;;){if(context_data_val<<=1,context_data_position==bitsPerChar-1){context_data.push(getCharFromInt(context_data_val));break}context_data_position++}return context_data.join("")}(input,6,function(index){return keyStrBase64.charAt(index)});switch(res.length%4){default:case 0:return res;case 1:return res+"===";case 2:return res+"==";case 3:return res+"="}}});var f,keyStrBase64,baseReverseDic;const puzzleAdd=(puzzle,feature,part,unique=!1)=>{void 0===puzzle[feature]&&(puzzle[feature]=[]),!0===unique&&((puzzle,feature,part)=>{part=JSON.stringify(part);return(puzzle[feature]||[]).map(item=>JSON.stringify(item)).includes(part)})(puzzle,feature,part)||("object"!=typeof part||Array.isArray(part)||(part=Object.keys(part).reduce((acc,cur)=>Object.assign(acc,void 0===part[cur]?{}:{[cur]:part[cur]}),{})),puzzle[feature].push(part))},puzzleAddFogLamp=(fpuzzle,puzzle,[r,c])=>{var rows=fpuzzle.grid.length,fpuzzle=fpuzzle.grid[0].length;for(let r0=Math.max(0,r-1),r1=Math.min(fpuzzle-1,r+1);r0<=r1;r0++)for(let c0=Math.max(0,c-1),c1=Math.min(rows-1,c+1);c0<=c1;c0++)puzzleAdd(puzzle,"foglight",[r0,c0],!0)},createBlankPuzzle=(fpuzzle,puzzle)=>{puzzle=Object.assign(puzzle,{cellSize:50,cells:[],regions:[]}),fpuzzle.metadata&&(puzzle.metadata=Object.assign(fpuzzle.metadata));let regRC=getRegionShape(fpuzzle.size||9),regions={};Array.isArray(fpuzzle.grid)&&fpuzzle.grid.forEach((row,r)=>{let newRow=[];puzzleAdd(puzzle,"cells",newRow),row.forEach((cell,c)=>{var newCell={},newCell=(newRow.push(newCell),cell.given&&(newCell.value=cell.value),cell.centerPencilMarks&&(newCell.centremarks=cell.centerPencilMarks),cell.cornerPencilMarks&&(newCell.pencilMarks=cell.cornerPencilMarks),((r,c,region)=>null===region?"null":void 0===region?Math.floor(r/regRC[0])*regRC[0]+Math.floor(c/regRC[1]):Number(region))(r,c,cell.region));void 0===regions[newCell]&&(regions[newCell]=[]),regions[newCell].push([r,c])})}),void 0!==regions.null&&(puzzleAdd(puzzle,"cages",{cells:regions.null,unique:!1,hidden:!0}),delete regions.null),Object.keys(regions).forEach(region=>puzzleAdd(puzzle,"regions",regions[region]))},reMetaTags=/^([^: ]+):\s*([\s\S]+)/m,reTransparentColor=/#([0-9a-f]{3}0|[0-9a-f]{6}00)/i,reAllBlankSolution=/^([.]*|0*)$/,puzzleAddMeta=(puzzle,key,val)=>{void 0===puzzle.metadata&&(puzzle.metadata={});puzzle=puzzle.metadata;void 0===puzzle[key]?puzzle[key]=val:(Array.isArray(puzzle[key])||(puzzle[key]=[puzzle[key]]),puzzle[key].push(val))},parseMetaData=(fpuzzle,puzzle)=>{(fpuzzle.cage||[]).forEach(cage=>{var _,metaVal;(cage=>{var noCells=0===(cage.cells||[]).length,noColor=reTransparentColor.test(cage.fontC||"#0000")&&reTransparentColor.test(cage.outlineC||"#0000"),cage=reMetaTags.test(String(cage.value)||"");return(noCells||noColor)&&cage})(cage)&&([_,cage,metaVal]=String(cage.value||"").match(reMetaTags)||[],puzzleAddMeta(puzzle,cage,metaVal))})},parseSolution=(fpuzzle,puzzle)=>{var{metadata={}}=puzzle;if(void 0===metadata.solution){var reDigit=/^\d$/,solution=[];if(Array.isArray(fpuzzle.grid))for(const row of fpuzzle.grid)for(const cell of row){if(!reDigit.test(cell.value))return;solution.push(reDigit.test(cell.value)?cell.value.toString():"?")}metadata=solution.join("");puzzleAddMeta(puzzle,"solution",metadata)}},fpuzzlesParseRC=rc=>rc.match(/R(\d+(?:\.\d*)?)C(\d+(?:\.\d*)?)/).slice(1,3).map(Number).map(n=>n-1),offsetRC=(or,oc)=>([r,c])=>[r+or,c+oc],getPartCenter=part=>{var sc,{cell,cells}=part;if("string"==typeof cell)return offsetRC(.5,.5)(fpuzzlesParseRC(cell));if(Array.isArray(cells)&&0<cells.length)return[cell,sc]=cells.reduce(([r,c],rc)=>offsetRC(r+.5,c+.5)(fpuzzlesParseRC(rc)),[0,0]),[cell/(cell=cells.length),sc/cell];throw new Error("Unable to calculate part center for: "+JSON.stringify(part))};var fpuzzlesParseMeta=(from,to)=>(fpuzzle,puzzle)=>{fpuzzle[from]&&puzzleAdd(puzzle,"cages",{value:to+": "+fpuzzle[from]})};const applyDefaultMeta=(fpuzzle,puzzle,metaName,metaDefaultFunc)=>{void 0===fpuzzle[metaName]&&"function"==typeof metaDefaultFunc&&void 0!==(metaDefaultFunc=metaDefaultFunc(fpuzzle,puzzle))&&(puzzle.cages=puzzle.cages||[],void 0===puzzle.cages.find(cage=>0===(cage.value||"").indexOf(metaName+": ")))&&puzzle.cages.push({value:metaName+": "+metaDefaultFunc})};const parse={size:(fpuzzle,puzzle)=>{},disabledlogic:(fpuzzle,puzzle)=>{},truecandidatesoptions:(fpuzzle,puzzle)=>{},grid:(fpuzzle,puzzle)=>{Array.isArray(fpuzzle.grid)&&fpuzzle.grid.forEach((row,r)=>{row.forEach((cell,c)=>{let col=cell.c||(cell.cArray||[])[0];Array.isArray(cell.cArray)&&1<cell.cArray.length&&console.warn("f-puzzles decoder does not currently support multiple given colors. Please submit this puzzle for testing."),void 0!==highlightColours[parseInt(col)]&&(col=highlightColours[parseInt(col)]),[null,void 0].includes(col)||puzzleAdd(puzzle,"underlays",{backgroundColor:col,center:[r+.5,c+.5],rounded:!1,width:1,height:1})})})}},reFPuzPrefix=(parse.author=fpuzzlesParseMeta("author","author"),parse.title=fpuzzlesParseMeta("title","title"),parse.author=fpuzzlesParseMeta("author","author"),parse.ruleset=fpuzzlesParseMeta("ruleset","rules"),parse.isSolutionBlank=solString=>reAllBlankSolution.test(solString),parse.mapSolDigit=n=>(1<(n=String(n)).length&&(console.warn('parsing fpuz: solution value "%s" not supported, substituting "?"',n),n="?"),n),parse.solution=(fpuzzle,puzzle)=>{let solution=fpuzzle.solution||[];fpuzzle=(solution="string"==typeof solution?solution.split(-1!==solution.indexOf(",")?",":""):solution).map(parse.mapSolDigit).join("");parse.isSolutionBlank(fpuzzle)||puzzleAdd(puzzle,"cages",{value:"solution: "+fpuzzle})},parse.antiknight=(fpuzzle,puzzle)=>{puzzleAddMeta(puzzle,"antiknight",fpuzzle.antiknight),fpuzzle.antiknight&&puzzleAdd(puzzle,"global","antiknight")},parse.antiking=(fpuzzle,puzzle)=>{puzzleAddMeta(puzzle,"antiking",fpuzzle.antiking),fpuzzle.antiking&&puzzleAdd(puzzle,"global","antiking")},parse.nonconsecutive=(fpuzzle,puzzle)=>{fpuzzle.nonconsecutive&&puzzleAdd(puzzle,"global","nonconsecutive")},parse.littlekillersum=(fpuzzle,puzzle)=>{(fpuzzle.littlekillersum||[]).forEach(part=>{var rc=offsetRC(.5,.5)(fpuzzlesParseRC(part.cell)),dir=littlekillerDirs[part.direction],part=void 0!==part.value?part.value:"_";puzzleAdd(puzzle,"arrows",{color:"#000000",thickness:2,wayPoints:[[rc[0]+.3*dir[0],rc[1]+.3*dir[1]],[rc[0]+.48*dir[0],rc[1]+.48*dir[1]]]}),puzzleAdd(puzzle,"overlays",{backgroundColor:"#FFFFFF",borderColor:"#FFFFFF",center:[rc[0]-0*dir[0],rc[1]-0*dir[1]],fontSize:28,width:.25,height:.25,rounded:!1,text:part})})},parse.arrow=(fpuzzle,puzzle)=>{let customStyle={};try{customStyle=JSON.parse((puzzle.metadata||{}).customstyle||"{}")}catch(err){console.warn('Invalid JSON in imported meta data "customStyle":',(puzzle.metadata||{}).customstyle)}customStyle.bulb&&customStyle.bulb.color&&(customStyle.bulb.borderColor=customStyle.bulb.color),(fpuzzle.arrow||[]).forEach(part=>{part.lines.forEach(line=>{line.length<=1&&console.error("Arrow has less than one point!");var line=line.map(fpuzzlesParseRC).map(offsetRC(.5,.5)),dr=line[1][0]-line[0][0],dc=line[1][1]-line[0][1],dist=Math.sqrt(dr*dr+dc*dc);line[0][0]+=Math.round(40*Math.sign(dr)/dist)/100,line[0][1]+=Math.round(40*Math.sign(dc)/dist)/100,puzzleAdd(puzzle,"arrows",Object.assign({color:"#a1a1a1",headLength:.3,thickness:5,wayPoints:line},customStyle.arrow))});var cells=part.cells.map(fpuzzlesParseRC).map(offsetRC(.5,.5)),[min,max]=(rcs=>{let min=[999,999],max=[-999,-999];return rcs.forEach(rc=>{min[0]=Math.min(min[0],rc[0]),max[0]=Math.max(max[0],rc[0]),min[1]=Math.min(min[1],rc[1]),max[1]=Math.max(max[1],rc[1])}),[min,max]})(cells);max[0]===min[0]||max[1]===min[1]?puzzleAdd(puzzle,"overlays",Object.assign({borderColor:"#a1a1a1",backgroundColor:"#ffffff",center:getPartCenter(part),fontSize:16,borderSize:5,rounded:!0,text:"",width:max[1]-min[1]+.83,height:max[0]-min[0]+.83},customStyle.bulb)):(part=Math.round(.7*("undefined"!=typeof SvgRenderer?SvgRenderer.CellSize:64)),puzzleAdd(puzzle,"lines",Object.assign({color:"#a1a1a1",thickness:part,opacity:.7,wayPoints:cells},customStyle.bulb)),puzzleAdd(puzzle,"lines",Object.assign({color:"#ffffff",thickness:part-10,opacity:.8,wayPoints:cells})))})},parse.killercage=(fpuzzle,puzzle)=>{(fpuzzle.killercage||[]).forEach(cage=>{var str,pCage={unique:!0};Array.isArray(cage.cells)&&(pCage.cells=cage.cells.map(fpuzzlesParseRC)),cage.value&&(pCage.value=cage.value),str=cage.value,Number.isInteger(Number(str))&&String(Number(str))===String(str)&&(pCage.sum=parseInt(cage.value)),puzzleAdd(puzzle,"cages",pCage)})},parse.cage=(fpuzzle,puzzle)=>{const reMetaCageValue=/^[a-z]+: /;(fpuzzle.cage||[]).forEach(cage=>{if("FOW"===cage.value&&1===cage.cells.length)return puzzleAddFogLamp(fpuzzle,puzzle,fpuzzlesParseRC(cage.cells[0]));if("FOGLIGHT"===cage.value)cage.cells.forEach(rc=>puzzleAdd(puzzle,"foglight",fpuzzlesParseRC(rc),!0));else{var cageOpts=Object.assign({},cage,{cells:cage.cells.map(fpuzzlesParseRC)});if(void 0===cageOpts.style)switch(cage.fromConstraint){case"Row Indexer":cageOpts.style="fpRowIndexer";break;case"Column Indexer":cageOpts.style="fpColumnIndexer";break;case"Box Indexer":cageOpts.style="fpBoxIndexer"}"string"==typeof cage.value&&cage.value.match(reMetaCageValue)&&delete cageOpts.cells,puzzleAdd(puzzle,"cages",cageOpts)}})},parse.fogofwar=(fpuzzle,puzzle)=>{(fpuzzle.fogofwar||[]).forEach(rc=>puzzleAddFogLamp(fpuzzle,puzzle,fpuzzlesParseRC(rc)))},parse.foglight=(fpuzzle,puzzle)=>{(fpuzzle.foglight||[]).forEach(rc=>puzzleAdd(puzzle,"foglight",fpuzzlesParseRC(rc),!0))},parse["diagonal+"]=(fpuzzle,puzzle)=>{var cellWidth;fpuzzle["diagonal+"]&&(fpuzzle=puzzle.cells.length,cellWidth=puzzle.cells.reduce((acc,cur)=>Math.max(cur.length,acc),0),puzzleAdd(puzzle,"lines",{color:"#34BBE6",thickness:2,wayPoints:[[0,cellWidth],[fpuzzle,0]]}))},parse["diagonal-"]=(fpuzzle,puzzle)=>{var cellWidth;fpuzzle["diagonal-"]&&(fpuzzle=puzzle.cells.length,cellWidth=puzzle.cells.reduce((acc,cur)=>Math.max(cur.length,acc),0),puzzleAdd(puzzle,"lines",{color:"#34BBE6",thickness:2,wayPoints:[[0,0],[fpuzzle,cellWidth]]}))},parse.ratio=(fpuzzle,puzzle)=>{(fpuzzle.ratio||[]).forEach(part=>{var opts={borderColor:"#000000",backgroundColor:"#000000",center:getPartCenter(part),rounded:!0,width:.3,height:.3,text:""};part.value&&(opts.color="#fff",opts.stroke="none",opts.text=part.value),puzzleAdd(puzzle,"overlays",opts)})},parse.difference=(fpuzzle,puzzle)=>{(fpuzzle.difference||[]).forEach(part=>{var opts={borderColor:"#000000",backgroundColor:"#FFFFFF",center:getPartCenter(part),rounded:!0,width:.3,height:.3,text:""};part.value&&(opts.color="#000",opts.stroke="none",opts.text=part.value),puzzleAdd(puzzle,"overlays",opts)})},parse.xv=(fpuzzle,puzzle)=>{(fpuzzle.xv||[]).forEach(part=>{puzzleAdd(puzzle,"overlays",{backgroundColor:"#FFFFFF",borderColor:"#FFFFFF",center:getPartCenter(part),fontSize:21,rounded:!1,width:.25,height:.25,text:part.value})})},parse.thermometer=(fpuzzle,puzzle)=>{(fpuzzle.thermometer||[]).forEach(part=>{part.lines.forEach(line=>{line=line.map(fpuzzlesParseRC).map(offsetRC(.5,.5));puzzleAdd(puzzle,"underlays",{borderColor:"#CFCFCF",backgroundColor:"#CFCFCF",center:line[0],rounded:!0,width:.85,height:.85}),puzzleAdd(puzzle,"lines",{color:"#CFCFCF",thickness:21,wayPoints:line})})})},parse.palindrome=(fpuzzle,puzzle)=>{(fpuzzle.palindrome||[]).forEach(part=>{part.lines.forEach(line=>{puzzleAdd(puzzle,"lines",{color:"#CFCFCF",thickness:16,wayPoints:line.map(fpuzzlesParseRC).map(offsetRC(.5,.5))})})})},parse.sandwichsum=(fpuzzle,puzzle)=>{(fpuzzle.sandwichsum||[]).forEach(part=>{puzzleAdd(puzzle,"overlays",{backgroundColor:"#FFFFFF",borderColor:"#FFFFFF",center:getPartCenter(part),fontSize:32,rounded:!1,width:.25,height:.25,text:part.value})})},parse.even=(fpuzzle,puzzle)=>{(fpuzzle.even||[]).forEach(part=>{puzzleAdd(puzzle,"underlays",{borderColor:"#CFCFCF",backgroundColor:"#CFCFCF",center:getPartCenter(part),rounded:!1,width:.7,height:.7})})},parse.odd=(fpuzzle,puzzle)=>{(fpuzzle.odd||[]).forEach(part=>{puzzleAdd(puzzle,"underlays",{borderColor:"#CFCFCF",backgroundColor:"#CFCFCF",center:offsetRC(.5,.5)(fpuzzlesParseRC(part.cell)),rounded:!0,width:.7,height:.7})})},parse.extraregion=(fpuzzle,puzzle)=>{(fpuzzle.extraregion||[]).forEach(extraregion=>{extraregion=extraregion.cells.map(fpuzzlesParseRC);puzzleAdd(puzzle,"cages",{style:"extraregion",unique:!0,sum:triangularNumber(extraregion.length),cells:extraregion})})},parse.clone=(fpuzzle,puzzle)=>{(fpuzzle.clone||[]).forEach(part=>{[...part.cells,...part.cloneCells].map(fpuzzlesParseRC).map(offsetRC(.5,.5)).forEach(cell=>{puzzleAdd(puzzle,"underlays",{borderColor:"#CFCFCF",backgroundColor:"#CFCFCF",center:cell,rounded:!1,width:1,height:1})})})},parse.quadruple=(fpuzzle,puzzle)=>{(fpuzzle.quadruple||[]).forEach(part=>{puzzleAdd(puzzle,"overlays",{backgroundColor:"#FFFFFF",borderColor:"#000000",center:getPartCenter(part),fontSize:14,rounded:!0,width:.7,height:.7,text:part.values.reduce((acc,cur,idx)=>acc+(idx%2==1?" ":"")+(idx%3==2?"\n":"")+cur,"")})})},parse.betweenline=(fpuzzle,puzzle)=>{(fpuzzle.betweenline||[]).forEach(part=>{part.lines.forEach(line=>{var line=line.map(fpuzzlesParseRC).map(offsetRC(.5,.5)),last=line.length-1,dr=(puzzleAdd(puzzle,"overlays",{borderColor:"#CFCFCF",backgroundColor:"#FFFFFF",center:[...line[0]],fontSize:16,borderSize:2,rounded:!0,width:.8,height:.8}),puzzleAdd(puzzle,"overlays",{borderColor:"#CFCFCF",backgroundColor:"#FFFFFF",center:[...line[last]],fontSize:16,borderSize:2,rounded:!0,width:.8,height:.8}),line[1][0]-line[0][0]),dc=line[1][1]-line[0][1],dist=Math.sqrt(dr*dr+dc*dc);line[0][0]+=Math.round(4*Math.sign(dr)/dist)/10,line[0][1]+=Math.round(4*Math.sign(dc)/dist)/10,dr=line[last-1][0]-line[last][0],dc=line[last-1][1]-line[last][1],dist=Math.sqrt(dr*dr+dc*dc),line[last][0]+=Math.round(4*Math.sign(dr)/dist)/10,line[last][1]+=Math.round(4*Math.sign(dc)/dist)/10,puzzleAdd(puzzle,"lines",{color:"#CFCFCF",thickness:2,wayPoints:line})})})},parse.lockout=(fpuzzle,puzzle)=>{},parse.minMax=(puzzle,cells=[],inwards=!0)=>{let minRC=[1,1],maxRC=[puzzle.cells.length,puzzle.cells[0].length],a=inwards?.44:.39,b=inwards?.39:.44,otherRCs=cells.map(({cell})=>cell);cells.forEach((part,idx,arr)=>{let center=getPartCenter(part);puzzleAdd(puzzle,"underlays",{backgroundColor:"#ccc",center:center,rounded:!1,width:1,height:1}),[[-1,0],[0,1],[1,0],[0,-1]].forEach(([dy,dx])=>{var neighbourRC=[Math.floor(center[0]+dy+1),Math.floor(center[1]+dx+1)];neighbourRC[0]<minRC[0]||neighbourRC[1]<minRC[1]||neighbourRC[0]>maxRC[0]||neighbourRC[1]>maxRC[1]||-1!==otherRCs.indexOf(`R${neighbourRC[0]}C`+neighbourRC[1])||puzzleAdd(puzzle,"lines",{color:"#000000",thickness:1,wayPoints:[[center[0]+dy*a+.1*dx,center[1]+dx*a+.1*dy],[center[0]+dy*b,center[1]+dx*b],[center[0]+dy*a-.1*dx,center[1]+dx*a-.1*dy]]})})})},parse.minimum=(fpuzzle,puzzle)=>{parse.minMax(puzzle,fpuzzle.minimum)},parse.maximum=(fpuzzle,puzzle)=>{parse.minMax(puzzle,fpuzzle.maximum,!1)},parse.line=(fpuzzle,puzzle)=>{(fpuzzle.line||[]).forEach(line=>{line.lines.forEach(points=>{puzzleAdd(puzzle,"lines",{color:line.outlineC,thickness:32*line.width,wayPoints:points.map(fpuzzlesParseRC).map(offsetRC(.5,.5))})})})},parse.rectangle=(fpuzzle,puzzle)=>{(fpuzzle.rectangle||[]).forEach(part=>{puzzleAdd(puzzle,"overlays",{backgroundColor:part.baseC,borderColor:part.outlineC,center:getPartCenter(part),borderSize:1,rounded:!1,width:part.width,height:part.height,text:part.value,angle:part.angle})})},parse.circle=(fpuzzle,puzzle)=>{(fpuzzle.circle||[]).forEach(part=>{puzzleAdd(puzzle,"overlays",{backgroundColor:part.baseC,borderColor:part.outlineC,textColor:part.fontC,center:getPartCenter(part),borderSize:1,rounded:!0,width:part.width,height:part.height,text:part.value,angle:part.angle})})},parse.text=(fpuzzle,puzzle)=>{(fpuzzle.text||[]).forEach(part=>{var text=part.value&&String(part.value).replace(/ /g," ");"string"==typeof text&&0<text.length&&puzzleAdd(puzzle,"overlays",{color:part.fontC,textStroke:["#fff","#ffffff"].includes((part.fontC||"").toLowerCase())?"#000":"#fff",center:getPartCenter(part),fontSize:Math.round(32*(part.size||1)),rounded:!1,width:.25,height:.25,text:text,angle:part.angle})})},parse.disjointgroups=(fpuzzle,puzzle)=>{var arr,{regions=[]}=puzzle,disjointGroups=[],regionCount=regions.length,largestRegion=([arr=[]]=[regions],arr.reduce((max,arr)=>Math.max(arr.length,max),0));for(let c=0;c<largestRegion;c++){disjointGroups[c]=[];for(let r=0;r<regionCount;r++)void 0!==regions[r][c]&&disjointGroups[c].push(regions[r][c])}disjointGroups.forEach(cells=>puzzleAdd(puzzle,"cages",{cells:cells,unique:!0,type:"disjoint",style:null})),puzzleAdd(puzzle,"global","disjoint")},parse.negative=(fpuzzle,puzzle)=>{for(const negConstraint of fpuzzle.negative||[])"foglight"===negConstraint?puzzleAdd(puzzle,"foglight",[],!0):puzzleAdd(puzzle,"global","anti"+negConstraint)},parse.triggereffect=(fpuzzle,puzzle)=>{fpuzzle.triggereffect.forEach(part=>puzzleAdd(puzzle,"triggereffect",part))},/^(fpuz(?:zles)?)(.*)/),stripPrefix=fpuzzle=>fpuzzle.replace(reFPuzPrefix,"$2"),fixFPuzzleSlashes=(data,maxTime=1e3,maxChecks=400)=>{const decompressPuzzle=base64Codec.decompress,reSlashFirst=/^[/](?=([^/]|$))/gm,reSlash=/[^/][/](?=([^/]|$))/gm;let checks=0,time=Date.now();const doubleSlashes=(data,n=1)=>{if(!(n<=0)){if(Date.now()-time>=maxTime)return console.error("fixFPuzzleSlashes timed out after %sms",Date.now()-time);if(checks++>=maxChecks)return console.error("fixFPuzzleSlashes exceeded %s max checks",checks);var res,slashes=(data=>{let m,idxs=[];for(reSlashFirst.lastIndex=0,(m=reSlashFirst.exec(data))&&idxs.push(m.index),reSlash.lastIndex=0;null!==(m=reSlash.exec(data));)idxs.push(m.index+1);return idxs})(data),len=slashes.length;for(let i=0;i<len;i++)if(res=data.substring(0,slashes[i])+"/"+data.substring(slashes[i]),1===n){if(decompressPuzzle(res))return res}else if(res=doubleSlashes(res,n-1))return res}};if(decompressPuzzle(data))return data;let n=1,fixed;for(;!fixed&&checks<maxChecks&&Date.now()-time<maxTime;)fixed=doubleSlashes(data,n),n++;return fixed},saveDecodeURIComponent=(str,dec)=>(dec=decodeURIComponent(str)).length<str.length?dec:str,createFpuzId=(puzzle,idPrefix="fpuzzle")=>idPrefix+md5Digest("string"==typeof puzzle?puzzle:base64Codec.compress(JSON.stringify(puzzle))),parseFPuzzle=fpuzzleRaw=>{let fpuzzle=fpuzzleRaw;var puzzle={id:createFpuzId(fpuzzle)},fpuzzleRaw=("string"==typeof fpuzzle&&(fpuzzle=JSON.parse(base64Codec.decompress(saveDecodeURIComponent(fpuzzle)))),createBlankPuzzle(fpuzzle,puzzle),parseMetaData(fpuzzle,puzzle),parseSolution(fpuzzle,puzzle),[...new Set([...layerOrder,...Object.keys(fpuzzle)])].filter(feature=>void 0!==fpuzzle[feature]));for(const feature of fpuzzleRaw)"function"!=typeof parse[feature]?loadPuzzle.logUnsupported&&console.error("Unsupported feature:",feature,fpuzzle[feature]):parse[feature](fpuzzle,puzzle);return applyDefaultMeta(fpuzzle,puzzle,"title",loadPuzzle.getDefaultTitle),applyDefaultMeta(fpuzzle,puzzle,"author",loadPuzzle.getDefaultAuthor),applyDefaultMeta(fpuzzle,puzzle,"rules",loadPuzzle.getDefaultRules),puzzle},fetchRawId=rawId=>rawId.length>fpuzzlesTinyIdLength?Promise.resolve(rawId):fetch("/api/puzzle/"+rawId).then(res=>res.json()).then(res=>res.result),loadPuzzle=rawId=>Promise.resolve().then(()=>fetchRawId(rawId)).then(stripPrefix).then(parseFPuzzle).then(puzzle=>(rawId.length<fpuzzlesTinyIdLength&&(puzzle.id=rawId),PuzzleZipper.zip(JSON.stringify(puzzle)))).catch(err=>(console.error("Error fetching FPuzzle:",err),Promise.reject(err)));const decodeFPuzzleData=fpuzzleData=>JSON.parse(base64Codec.decompress(fixFPuzzleSlashes(saveDecodeURIComponent(fpuzzleData)))),encodeFPuzzleData=fpuzzle=>base64Codec.compress(JSON.stringify(fpuzzle));return loadPuzzle.reFPuzPrefix=reFPuzPrefix,loadPuzzle.stripPrefix=stripPrefix,loadPuzzle.logUnsupported=!1,loadPuzzle.fetchRawId=fetchRawId,loadPuzzle.createFpuzId=createFpuzId,loadPuzzle.parseFPuzzle=parseFPuzzle,loadPuzzle.decompressPuzzle=base64Codec.decompress,loadPuzzle.compressPuzzle=base64Codec.compress,loadPuzzle.fixFPuzzleSlashes=fixFPuzzleSlashes,loadPuzzle.saveDecodeURIComponent=saveDecodeURIComponent,loadPuzzle.getRegionShape=getRegionShape,loadPuzzle.getDefaultTitle=(fpuzzle,puzzle)=>"Untitled",loadPuzzle.getDefaultAuthor=(fpuzzle,puzzle)=>"Unknown",loadPuzzle.getDefaultRules=(fpuzzle,puzzle)=>"No rules provided for this puzzle. Please check the related video or website for rules.",loadPuzzle.cleanPuzzlePackage=puzzlePackage=>{if(puzzlePackage.match(reFPuzPrefix))try{var fpuzzle=JSON.parse(loadFPuzzle.decompressPuzzle(saveDecodeURIComponent(puzzlePackage.replace(/^fpuzzles/,""))));(fpuzzle.cage||[]).forEach(cage=>{(cage.value||"").match(/^customstyle: /)&&(cage.cells.length=0)}),puzzlePackage="fpuzzles"+saveDecodeURIComponent(loadFPuzzle.compressPuzzle(JSON.stringify(fpuzzle)))}catch(err){console.error(err)}return puzzlePackage},loadPuzzle.decodeFPuzzleData=decodeFPuzzleData,loadPuzzle.encodeFPuzzleData=encodeFPuzzleData,loadPuzzle.addSolution=(fpuzzleData,s81)=>encodeFPuzzleData(Object.assign(decodeFPuzzleData(fpuzzleData),{solution:s81.split("")})),loadPuzzle.saveDecompress=data=>{let res;try{(null===(res=loadPuzzle.decompressPuzzle(data))||res.length<.5*data.length)&&(res=data)}catch(err){console.warn("loadFPuzzle.saveDecompress:",err),res=data}return res},loadPuzzle})(),PuzzleZipper=("undefined"!=typeof module&&(module.exports=loadFPuzzle),(()=>{const propMap={color:"c",cages:"ca",center:"ct",borderColor:"c1",backgroundColor:"c2",cells:"ce",cellSize:"cs",arrows:"a",overlays:"o",underlays:"u",width:"w",height:"h",value:"v",videos:"vd",lines:"l",rounded:"r",regions:"re",fontSize:"fs",thickness:"th",headLength:"hl",wayPoints:"wp",title:"t",text:"te",duration:"d",d:"d2"},clearEmptyArrays=o=>(Array.isArray(o)?o.forEach(v=>clearEmptyArrays(v)):null!==o&&"object"==typeof o&&Object.keys(o).forEach(key=>{clearEmptyArrays(o[key]),Array.isArray(o[key])&&0===o[key].length&&delete o[key]}),o),mapProps=(o,map)=>(Array.isArray(o)?o.forEach(v=>mapProps(v,map)):null!==o&&"object"==typeof o&&Object.keys(o).forEach(key=>{if(void 0!==map[key]){if(void 0!==o[map[key]])throw new Error("Prop mapping collission from "+key+": "+o[key]+" to "+map[key]+": "+o[map[key]]);o[map[key]]=o[key],delete o[key],key=map[key]}mapProps(o[key],map)}),o),mapValues=(o,mapFunc)=>(Array.isArray(o)?o.forEach((v,idx)=>o[idx]=mapValues(v,mapFunc)):null!==o&&"object"==typeof o?Object.keys(o).forEach(key=>o[key]=mapValues(o[key],mapFunc)):o=mapFunc(o),o),zipQuotes=str=>str.replace(/\'/g,"\\'").replace(/"/g,"'"),unzipQuotes=str=>-1!==str.indexOf('"')?str:str.replace(/(?!<\\)\\'/g,"’").replace(/'/g,'"').replace(/’/g,"'");const reQuotedStringSplit=/("(?:[^"]|\\"])*")/gm,reQuotedMarkerSplit=/("__{S[0-9]+}__")/,reQuotedMarker=/"__{S([0-9]+)}__"/;return{propMap:propMap,zip:jsonStr=>{"string"!=typeof jsonStr&&(jsonStr=JSON.stringify(jsonStr));jsonStr=JSON.parse(jsonStr);return clearEmptyArrays(jsonStr),mapProps(jsonStr,propMap),mapValues(jsonStr,v=>v="string"==typeof v&&String(parseInt(v))===v?parseInt(v):v),jsonStr=JSON.stringify(jsonStr).replace(/([\,\{\[])\"([a-zA-Z0-9]+)\"\:/gm,"$1$2:").replace(/([\,\{\[]){}(?=[,\}\]])/gm,"$1").replace(/(:)false([,\}\]])/gm,"$1f$2").replace(/(:)true([,\}\]])/gm,"$1t$2").replace(/(:)"#000000"([,\}\]])/gm,"$1#0$2").replace(/(:)"#FFFFFF"([,\}\]])/gm,"$1#F$2").replace(/(:)"#([0-9a-fA-F]{6})"([,\}\]])/gm,"$1$2$3"),zipQuotes(jsonStr)},unzip:zipped=>{let res=unzipQuotes(zipped);var str,strings,zipped=(str=>{str=str.split(reQuotedStringSplit);return{str:str.map((s,i)=>i%2?`"__{S${Math.floor(i/2)}}__"`:s).join(""),strings:str.filter((s,i)=>i%2)}})(res);res=(res=zipped.str).replace(/([\,\{\[])([a-zA-Z0-9]+)\:/gm,'$1"$2":').replace(/([\,\{\[])(?=[,\}\]])/gm,"$1_").replace(/{_}/gm,"{}").replace(/([\,\{\[])_/gm,"$1{}").replace(/(:)f([,\}\]])/gm,"$1false$2").replace(/(:)t([,\}\]])/gm,"$1true$2").replace(/(:)#0([,\}\]])/gm,'$1"#000000"$2').replace(/(:)#F([,\}\]])/gm,'$1"#FFFFFF"$2').replace(/(:)([0-9a-fA-F]{6})([,\}\]])/gm,'$1"#$2"$3'),res=(str=res,strings=zipped.strings,str.split(reQuotedMarkerSplit).map(s=>{var m=s.match(reQuotedMarker);return null!==m?strings[parseInt(m[1])]:s}).join("")),res=JSON.parse(res);const revMap={};return Object.keys(propMap).forEach(key=>revMap[propMap[key]]=key),mapProps(res,revMap),mapValues(res,v=>v="string"==typeof v&&v.match(/^([0-9a-fA-F]{6})$/)?v.replace(/^([0-9a-fA-F]{6})$/,"#$1"):v),JSON.stringify(res)},zipQuotes:zipQuotes,unzipQuotes:unzipQuotes,saveJsonUnzip:data=>{if("object"==typeof data)return data;try{return JSON.parse(data)}catch(err){try{return JSON.parse(PuzzleZipper.unzip(data))}catch(err){return console.error("saveJsonUnzip:",err),data}}}}})()),LZipper=function(){const fcc=String.fromCharCode;function data16to8Bit(str){for(var c,res="",len=str.length,i=0;i<len;i++)c=str.charCodeAt(i),res=(res+=String.fromCharCode(c>>8&255))+String.fromCharCode(255&c);return res}function data8to16Bit(str){for(var c,res="",len=str.length,i=0;i<len;i++)c=(255&str.charCodeAt(i))<<8,++i<len&&(c+=255&str.charCodeAt(i)),res+=fcc(c);return res}function compress(data){function dec(numBits,v,noShift){for(var m=noShift?0xffffffffff:1,i=0;i<numBits;i++)val=val<<1|v&m,15===pos?(pos=0,str+=fcc(val),val=0):pos++,noShift?v=0:v>>=1}if(null==data||""===data)return"";for(var wc,numBits,pos,c,len=data.length,dic={},w=(w="",""),enlargeIn=numBits=2,dictSize=3,str="",val=pos=0,ii=0;ii<len;ii+=1)void 0===dic[c=data.charAt(ii)]&&(dic[c]={size:dictSize++,create:!0}),w=void 0!==dic[wc=w+c]?wc:(dic[w].create?(w.charCodeAt(0)<256?(dec(numBits,0),dec(8,w.charCodeAt(0))):(dec(numBits,1,!0),dec(16,w.charCodeAt(0))),0===--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),dic[w].create=!1):dec(numBits,dic[w].size),0===--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),void 0!==dic[wc]?dic[wc].size=dictSize++:dic[wc]={size:dictSize++,create:!1},String(c));for(""!==w&&(dic[w].create?(w.charCodeAt(0)<256?(dec(numBits,0),dec(8,w.charCodeAt(0))):(dec(numBits,1,!0),dec(16,w.charCodeAt(0))),0===--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),dic[w].create=!1):dec(numBits,dic[w].size),0===--enlargeIn)&&(enlargeIn=Math.pow(2,numBits),numBits++),dec(numBits,2);;){if(val<<=1,15==pos){str+=fcc(val);break}pos++}return str}function decompress(cp){var dic,len,s,w,bits,c,enlargeIn,dicSize,numBits,entry,result,str,val,pos,index;function dec(maxP){for(var p=1,b=0;p!=maxP;)b|=(0<(val&pos)?1:0)*p,p<<=1,0===(pos>>=1)&&(pos=32768,val=str.charCodeAt(index++));return b}if(null===cp||""===cp||void 0===cp)return"";if(dic=[0,1,2],len=cp.length,s=[256,65536],enlargeIn=dicSize=4,numBits=3,entry=result="",val=(str=cp).charCodeAt(0),pos=32768,index=1,2===(bits=dec(4)))return"";for(bits<2&&(bits=dec(s[bits]),c=fcc(bits)),dic[3]=w=result=c;;){if(len<index)return"";if(c=bits=dec(Math.pow(2,numBits)),2===bits)return result;if(bits<2&&(bits=dec(s[bits]),dic[dicSize++]=fcc(bits),c=dicSize-1,enlargeIn--),0===enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),dic[c])entry=dic[c];else{if(c!==dicSize)return"";entry=w+w.charAt(0)}result+=entry,dic[dicSize++]=w+entry.charAt(0),w=entry,0===--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++)}}return{compact256:str=>data16to8Bit(compress(str)),expand256:str=>decompress(data8to16Bit(str)),compact64:str=>btoa(data16to8Bit(compress(str))),expand64:str=>decompress(data8to16Bit(atob(str)))}}(),metaTagsWithoutCells=["title","author","rules","solution","msgcorrect","msgincorrect","msgvalid","msginvalid","msgunknown"],highlightColours="#a8a8a8a8,#000,#ffa0a0,#ffdf61,#feffaf,#b0ffb0,#61d060,#d0d0ff,#8180f0,#ff08ff,#ffd0d0".split(","),patchFpuz=puzzlePackage=>{var saveJsonUnzip=PuzzleZipper["saveJsonUnzip"],reFPuzzle=/^fpuz(zles)?/;if(null===puzzlePackage.match(reFPuzzle))return puzzlePackage;var{fixFPuzzleSlashes,saveDecodeURIComponent,saveDecompress,compressPuzzle}=loadFPuzzle;let fpuzzle=saveJsonUnzip(saveDecompress(fixFPuzzleSlashes(saveDecodeURIComponent(puzzlePackage.replace(reFPuzzle,"")))));void 0!==fpuzzle.killercage&&((fpuzzle.killercage||[]).forEach(cage=>{void 0===fpuzzle.cage&&(fpuzzle.cage=[]),fpuzzle.cage.push(Object.assign({},cage,{unique:!0}))}),delete fpuzzle.killercage);const reMetaTagsStripCells=new RegExp(`^(${metaTagsWithoutCells.join("|")}):\\s*([\\s\\S]+)`,"im");return Array.isArray(fpuzzle.grid)&&fpuzzle.grid.forEach((row,r)=>(row||[]).forEach((cell,c)=>{let col=cell.c||(cell.cArray||[])[0];void 0!==highlightColours[parseInt(col)]&&(col=highlightColours[parseInt(col)]),[null,void 0].includes(col)||void 0===cell.c&&(cell.c=col)})),Array.isArray(fpuzzle.cage)&&(fpuzzle.cage||[]).forEach(cage=>{var[,metaName,metaVal]=String(cage.value||"").match(reMetaTagsStripCells)||[];metaName?(metaName=metaName+": "+metaVal.replace(/\n/g,"</br>"),cage.value=metaName,cage.cells.length=0,delete cage.fontC,delete cage.outlineC):(cage.fontC=cage.fontC||"#000",cage.outlineC=cage.outlineC||"#000")}),"fpuzzles"+encodeURIComponent(compressPuzzle(JSON.stringify(fpuzzle)))},patchSCLPuzzle=puzzlePackage=>{const rePrefix=/^(scl|ctc)/;if(null===puzzlePackage.match(rePrefix))return puzzlePackage;const{saveDecompress,saveDecodeURIComponent}=loadFPuzzle,{zip,propMap,saveJsonUnzip}=PuzzleZipper,compact64=LZipper["compact64"],CS="undefined"!=typeof SvgRenderer?SvgRenderer.CellSize:64;const puzzle=(package=>{var{duration:durationSaved,d:dSaved}=propMap,package=saveJsonUnzip(saveDecompress(saveDecodeURIComponent(package.replace(rePrefix,""))));return void 0===durationSaved?delete propMap.duration:propMap.duration=durationSaved,void 0===dSaved?delete propMap.d:propMap.d=dSaved,package})(puzzlePackage),reKropkiPath=/^M(\d+(?:\.\d+)?) (\d+(?:\.\d+)?)a14\.1 14\.1 1 0 0 28\.2 0l0 0a14\.1 14\.1 1 0 0 -28\.2 0z$/,toHalfRC=([row,col])=>[Math.round(parseFloat(row)/CS*2)/2,Math.round(parseFloat(col)/CS*2)/2];return Object.keys(puzzle).forEach(feature=>{var featureParts=puzzle[feature];if(Array.isArray(featureParts)){const deleteParts=[],fixKropki=(part,idx)=>{var kropki=(part=>{part=String(part.d).match(reKropkiPath);return part&&toHalfRC(part.slice(1,3).reverse())||!1})(part);kropki&&(((puzzle,feature,part,unique=!1)=>{void 0===puzzle[feature]&&(puzzle[feature]=[]),!0===unique&&puzzleHas(puzzle,feature,part)||("object"!=typeof part||Array.isArray(part)||(part=Object.keys(part).reduce((acc,cur)=>Object.assign(acc,void 0===part[cur]?{}:{[cur]:part[cur]}),{})),puzzle[feature].push(part))})(puzzle,"overlays",{borderColor:"#000",backgroundColor:part.fill,center:kropki,rounded:!0,width:.3,height:.3}),deleteParts.push(idx))};featureParts.forEach((part,idx)=>{if(0===Object.keys(part).length)return deleteParts.push(idx);"cages"===feature&&((part={})=>{part.fontC=part.fontC||"#000",part.outlineC=part.outlineC||"#000"})(part),((part,idx)=>!0===part.hidden&&deleteParts.push(idx))(part,idx),(part=>"cages"===part.target&&(part.target="cell-grids"))(part),fixKropki(part,idx)}),puzzle[feature]=puzzle[feature].filter((part,idx)=>!deleteParts.includes(idx))}}),(puzzle=>{var{duration:durationSaved,d:dSaved}=propMap,puzzle=(propMap.duration="dur",propMap.d="d2","ctc"+encodeURIComponent(compact64(zip(JSON.stringify(puzzle)))));return void 0===durationSaved?delete propMap.duration:propMap.duration=durationSaved,void 0===dSaved?delete propMap.d:propMap.d=dSaved,puzzle})(puzzle)};